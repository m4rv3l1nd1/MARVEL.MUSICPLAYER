<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pingpong dengan Tracking Tangan dan Titik Landmark</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    #videoElement {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      transform: scaleX(-1); /* Flip video horizontally for better hand tracking */
    }
  </style>
</head>
<body>

<video id="videoElement" width="640" height="480" autoplay muted></video>
<canvas id="pingpongGame" width="640" height="480"></canvas>

<!-- Memuat MediaPipe untuk pelacakan tangan -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

<script>
  const canvas = document.getElementById("pingpongGame");
  const ctx = canvas.getContext("2d");

  const paddleWidth = 10, paddleHeight = 100;
  const ballRadius = 10;
  const speed = 6;

  let ballX = canvas.width / 2, ballY = canvas.height / 2;
  let ballSpeedX = speed, ballSpeedY = speed;
  let leftPaddleY = (canvas.height - paddleHeight) / 2;
  let rightPaddleY = (canvas.height - paddleHeight) / 2;

  let isLeftHandDetected = false, isRightHandDetected = false;
  let leftHandY = 0, rightHandY = 0;

  // Setup untuk MediaPipe Hands
  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });
  hands.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  hands.onResults(onResults);

  // Mengakses kamera pengguna
  async function setupCamera() {
    const video = document.getElementById("videoElement");
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: 640, height: 480 }
    });
    video.srcObject = stream;

    const canvasElement = document.createElement("canvas");
    const canvasCtx = canvasElement.getContext("2d");

    function detectHands() {
      canvasElement.width = video.videoWidth;
      canvasElement.height = video.videoHeight;
      canvasCtx.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
      hands.send({ image: canvasElement });
      requestAnimationFrame(detectHands);
    }

    detectHands();
  }

  // Fungsi untuk menggambar game
  function drawGame() {
    // Gambar latar belakang dengan video feed
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Gambar bola
    ctx.beginPath();
    ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
    ctx.fillStyle = "white";
    ctx.fill();
    ctx.closePath();

    // Gambar paddle kiri
    ctx.fillStyle = "white";
    ctx.fillRect(0, leftPaddleY, paddleWidth, paddleHeight);

    // Gambar paddle kanan
    ctx.fillRect(canvas.width - paddleWidth, rightPaddleY, paddleWidth, paddleHeight);

    // Gerakan bola
    ballX += ballSpeedX;
    ballY += ballSpeedY;

    // Pantulkan bola pada dinding atas dan bawah
    if (ballY - ballRadius < 0 || ballY + ballRadius > canvas.height) {
      ballSpeedY = -ballSpeedY;
    }

    // Pantulkan bola pada paddle kiri
    if (ballX - ballRadius < paddleWidth && ballY > leftPaddleY && ballY < leftPaddleY + paddleHeight) {
      ballSpeedX = -ballSpeedX;
    }

    // Pantulkan bola pada paddle kanan
    if (ballX + ballRadius > canvas.width - paddleWidth && ballY > rightPaddleY && ballY < rightPaddleY + paddleHeight) {
      ballSpeedX = -ballSpeedX;
    }

    // Jika bola keluar dari kanan atau kiri
    if (ballX - ballRadius < 0 || ballX + ballRadius > canvas.width) {
      resetBall();
    }

    // Gerakan paddle kiri sesuai dengan tangan kiri
    if (isLeftHandDetected) {
      leftPaddleY = Math.min(Math.max(leftHandY - paddleHeight / 2, 0), canvas.height - paddleHeight);
    }

    // Gerakan paddle kanan sesuai dengan tangan kanan
    if (isRightHandDetected) {
      rightPaddleY = Math.min(Math.max(rightHandY - paddleHeight / 2, 0), canvas.height - paddleHeight);
    }
  }

  // Reset bola ke tengah
  function resetBall() {
    ballX = canvas.width / 2;
    ballY = canvas.height / 2;
    ballSpeedX = -ballSpeedX;
    ballSpeedY = speed;
  }

  // Fungsi hasil deteksi dari MediaPipe Hands
  function onResults(results) {
    if (results.multiHandLandmarks) {
      // Cek jika tangan kiri terdeteksi
      if (results.multiHandLandmarks[0]) {
        leftHandY = results.multiHandLandmarks[0][9].y * canvas.height; // Landmark untuk pergelangan tangan
        isLeftHandDetected = true;
      } else {
        isLeftHandDetected = false;
      }

      // Cek jika tangan kanan terdeteksi
      if (results.multiHandLandmarks[1]) {
        rightHandY = results.multiHandLandmarks[1][9].y * canvas.height; // Landmark untuk pergelangan tangan
        isRightHandDetected = true;
      } else {
        isRightHandDetected = false;
      }

      // Gambar titik-titik di setiap landmark tangan
      drawLandmarks(results.multiHandLandmarks);
    }
  }

  // Gambar titik pada setiap landmark tangan
  function drawLandmarks(handLandmarks) {
    handLandmarks.forEach((landmarks) => {
      for (let i = 0; i < landmarks.length; i++) {
        const x = landmarks[i].x * canvas.width;
        const y = landmarks[i].y * canvas.height;
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);  // Gambar titik
        ctx.fillStyle = "red";  // Warna titik
        ctx.fill();
        ctx.closePath();
      }
    });
  }

  // Mulai permainan dan setup kamera
  setupCamera();

  // Main game loop
  function gameLoop() {
    drawGame();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
</script>

</body>
</html>
